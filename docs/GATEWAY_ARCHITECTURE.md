# CloudDrive Gateway Architecture Documentation

## ğŸ“‹ ç›®å½•
- [1. Gatewayæ€»ä½“æ¶æ„](#1-gatewayæ€»ä½“æ¶æ„)
- [2. ç«¯å£æ¶æ„è®¾è®¡](#2-ç«¯å£æ¶æ„è®¾è®¡)
- [3. æ¥å£æ¶æ„è®¾è®¡](#3-æ¥å£æ¶æ„è®¾è®¡)
- [4. æœåŠ¡å‘ç°æ¶æ„](#4-æœåŠ¡å‘ç°æ¶æ„)
- [5. ç½‘å…³è¿‡æ»¤å™¨æ¶æ„](#5-ç½‘å…³è¿‡æ»¤å™¨æ¶æ„)
- [6. è·¨åŸŸå’Œå®‰å…¨æ¶æ„](#6-è·¨åŸŸå’Œå®‰å…¨æ¶æ„)
- [7. ç›‘æ§å’Œæ—¥å¿—æ¶æ„](#7-ç›‘æ§å’Œæ—¥å¿—æ¶æ„)
- [8. éƒ¨ç½²æ¶æ„](#8-éƒ¨ç½²æ¶æ„)
- [9. APIæ¥å£æ¸…å•](#9-apiæ¥å£æ¸…å•)
- [10. æœ€ä½³å®è·µå’Œæ‰©å±•](#10-æœ€ä½³å®è·µå’Œæ‰©å±•)

---

## 1. Gatewayæ€»ä½“æ¶æ„

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   Client Layer                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   Web UI    â”‚  â”‚ Mobile App  â”‚  â”‚   Admin     â”‚  â”‚  3rd Party  â”‚                â”‚
â”‚  â”‚  (Vue.js)   â”‚  â”‚             â”‚  â”‚  Console    â”‚  â”‚     API     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                Gateway Layer                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Spring Cloud Gateway (8080)                             â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚   Routing   â”‚  â”‚  Load       â”‚  â”‚   Filter    â”‚  â”‚    CORS     â”‚       â”‚   â”‚
â”‚  â”‚  â”‚   Engine    â”‚  â”‚  Balancer   â”‚  â”‚   Chain     â”‚  â”‚   Handler   â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚   Service   â”‚  â”‚  Path       â”‚  â”‚   Health    â”‚  â”‚   Metrics   â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  Discovery  â”‚  â”‚  Rewrite    â”‚  â”‚   Check     â”‚  â”‚ Collection  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Service Registry                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            Nacos (8848)                                    â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚   Service   â”‚  â”‚   Config    â”‚  â”‚   Health    â”‚  â”‚   Namespace â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  Registry   â”‚  â”‚  Center     â”‚  â”‚   Monitor   â”‚  â”‚  Management â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Microservices Layer                                   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚    User     â”‚  â”‚    File     â”‚  â”‚    Admin    â”‚  â”‚ Membership  â”‚               â”‚
â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚   Service   â”‚  â”‚   Service   â”‚               â”‚
â”‚  â”‚   (8081)    â”‚  â”‚   (8082)    â”‚  â”‚   (8083)    â”‚  â”‚   (8084)    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   MySQL     â”‚  â”‚    Redis    â”‚  â”‚   Hadoop    â”‚  â”‚    Flink    â”‚               â”‚
â”‚  â”‚   (3307)    â”‚  â”‚   (6379)    â”‚  â”‚   HDFS      â”‚  â”‚   (8085)    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ç»„ä»¶è§’è‰²è¯´æ˜

| ç»„ä»¶ | è§’è‰² | èŒè´£ |
|------|------|------|
| **Spring Cloud Gateway** | APIç½‘å…³ | ç»Ÿä¸€å…¥å£ã€è·¯ç”±è½¬å‘ã€è´Ÿè½½å‡è¡¡ |
| **Nacos** | æœåŠ¡æ³¨å†Œä¸­å¿ƒ | æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ã€å¥åº·æ£€æŸ¥ |
| **User Service** | ç”¨æˆ·æœåŠ¡ | ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç† |
| **File Service** | æ–‡ä»¶æœåŠ¡ | æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€ç®¡ç† |
| **Admin Service** | ç®¡ç†æœåŠ¡ | ç³»ç»Ÿç®¡ç†ã€ç›‘æ§ |
| **Membership Service** | ä¼šå‘˜æœåŠ¡ | è®¢é˜…ç®¡ç†ã€æ”¯ä»˜å¤„ç† |

### 1.3 æŠ€æœ¯æ ˆé€‰æ‹©

- **ç½‘å…³æ¡†æ¶**: Spring Cloud Gateway 3.1.x
- **æœåŠ¡æ³¨å†Œ**: Nacos 2.2.0
- **è´Ÿè½½å‡è¡¡**: Spring Cloud LoadBalancer
- **é…ç½®ç®¡ç†**: Spring Cloud Config + Nacos
- **ç›‘æ§**: Spring Boot Actuator + Micrometer
- **æ—¥å¿—**: SLF4J + Logback

---

## 2. ç«¯å£æ¶æ„è®¾è®¡

### 2.1 æœåŠ¡ç«¯å£åˆ†é…è¡¨

| æœåŠ¡åç§° | å†…éƒ¨ç«¯å£ | å¤–éƒ¨ç«¯å£ | åè®® | çŠ¶æ€ | è¯´æ˜ |
|----------|----------|----------|------|------|------|
| **Gateway** | 8080 | 8080 | HTTP | âœ… è¿è¡Œ | APIç½‘å…³ç»Ÿä¸€å…¥å£ |
| **User Service** | 8081 | 8081 | HTTP | âœ… è¿è¡Œ | ç”¨æˆ·è®¤è¯æœåŠ¡ |
| **File Service** | 8082 | 8082 | HTTP | âœ… è¿è¡Œ | æ–‡ä»¶ç®¡ç†æœåŠ¡ |
| **Admin Service** | 8083 | 8083 | HTTP | âœ… è¿è¡Œ | ç³»ç»Ÿç®¡ç†æœåŠ¡ |
| **Membership Service** | 8084 | 8084 | HTTP | âœ… è¿è¡Œ | ä¼šå‘˜è®¢é˜…æœåŠ¡ |
| **Nacos** | 8848 | 8848 | HTTP | âœ… è¿è¡Œ | æœåŠ¡æ³¨å†Œä¸­å¿ƒ |
| **MySQL** | 3306 | 3307 | TCP | âœ… è¿è¡Œ | ä¸»æ•°æ®åº“ |
| **Redis** | 6379 | 6379 | TCP | âœ… è¿è¡Œ | ç¼“å­˜æœåŠ¡ |
| **Hadoop NameNode** | 9870 | 9870 | HTTP | âœ… è¿è¡Œ | HDFSç®¡ç†ç•Œé¢ |
| **Flink Dashboard** | 8081 | 8085 | HTTP | âœ… è¿è¡Œ | æµå¤„ç†ç›‘æ§ |

### 2.2 ç½‘ç»œæ‹“æ‰‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                Docker Network                                       â”‚
â”‚                              cloud-drive-network                                   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8080    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8081    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8082          â”‚
â”‚  â”‚   Gateway   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ User Serviceâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚File Service â”‚                â”‚
â”‚  â”‚   (8080)    â”‚          â”‚   (8081)    â”‚          â”‚   (8082)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                         â”‚                         â”‚                      â”‚
â”‚         â”‚                         â”‚                         â”‚                      â”‚
â”‚         â–¼                         â–¼                         â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8848    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8083    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8084          â”‚
â”‚  â”‚    Nacos    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Admin Serviceâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Membership  â”‚                â”‚
â”‚  â”‚   (8848)    â”‚          â”‚   (8083)    â”‚          â”‚   (8084)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                         â”‚                         â”‚                      â”‚
â”‚         â”‚                         â”‚                         â”‚                      â”‚
â”‚         â–¼                         â–¼                         â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :3307    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :6379    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :9870          â”‚
â”‚  â”‚    MySQL    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    Redis    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Hadoop    â”‚                â”‚
â”‚  â”‚   (3307)    â”‚          â”‚   (6379)    â”‚          â”‚   (9870)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                Host Network                                         â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8080    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :3000    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” :8848          â”‚
â”‚  â”‚   Gateway   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Frontend   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    Nacos    â”‚                â”‚
â”‚  â”‚   (8080)    â”‚          â”‚   (3000)    â”‚          â”‚   (8848)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ç«¯å£å†²çªè§£å†³æ–¹æ¡ˆ

#### 2.3.1 MySQLç«¯å£å†²çª
- **é—®é¢˜**: æœ¬åœ°MySQLä½¿ç”¨3306ç«¯å£
- **è§£å†³**: Dockeræ˜ å°„ `3307:3306`
- **é…ç½®**: åº”ç”¨è¿æ¥`localhost:3307`

#### 2.3.2 Flinkç«¯å£å†²çª
- **é—®é¢˜**: Flink Dashboardä¸User Serviceéƒ½ä½¿ç”¨8081
- **è§£å†³**: Flink Dashboardæ˜ å°„åˆ°8085
- **é…ç½®**: è®¿é—®`localhost:8085`æŸ¥çœ‹Flink

#### 2.3.3 å¼€å‘ç¯å¢ƒç«¯å£ç®¡ç†
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep :8080

# ç«¯å£å†²çªæ—¶çš„å¤„ç†
docker-compose down
docker-compose up -d --remove-orphans
```

---

## 3. æ¥å£æ¶æ„è®¾è®¡

### 3.1 APIè·¯ç”±æ˜ å°„è§„åˆ™

#### 3.1.1 è·¯ç”±è§„åˆ™è¡¨

| å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | ç›®æ ‡æœåŠ¡ | è¿‡æ»¤å™¨ | çŠ¶æ€ |
|----------|----------|----------|--------|------|
| `/api/users/**` | `/users/**` | user-service | StripPrefix=1 | âœ… æ¿€æ´» |
| `/api/files/**` | `/files/**` | file-service | StripPrefix=1 | âœ… æ¿€æ´» |
| `/api/admin/**` | `/admin/**` | admin-service | StripPrefix=1 | âœ… æ¿€æ´» |
| `/api/membership/**` | `/membership/**` | membership-service | StripPrefix=1 | âœ… æ¿€æ´» |
| `/api/subscription/**` | `/subscription/**` | membership-service | StripPrefix=1 | âœ… æ¿€æ´» |
| `/api/payment/**` | `/payment/**` | membership-service | StripPrefix=1 | âœ… æ¿€æ´» |
| `/api/auth/**` | `/auth/**` | auth-service | StripPrefix=1 | â³ å¾…å¼€å‘ |

#### 3.1.2 è·¯å¾„é‡å†™æœºåˆ¶

```yaml
# è·¯å¾„é‡å†™è§„åˆ™
filters:
  - StripPrefix=1  # å»æ‰ç¬¬ä¸€ä¸ªè·¯å¾„æ®µ
  
# ç¤ºä¾‹ï¼š
# è¯·æ±‚: GET /api/membership/levels
# é‡å†™: GET /membership/levels
# è½¬å‘: http://membership-service:8084/membership/levels
```

### 3.2 è¯·æ±‚è½¬å‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Request Flow                                           â”‚
â”‚                                                                                     â”‚
â”‚  Client Request                                                                     â”‚
â”‚  GET /api/membership/levels                                                         â”‚
â”‚           â”‚                                                                         â”‚
â”‚           â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Gateway (8080)                                      â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  1. Route Matching                                                          â”‚   â”‚
â”‚  â”‚     Pattern: /api/membership/**                                             â”‚   â”‚
â”‚  â”‚     Match: âœ… /api/membership/levels                                        â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  2. Service Discovery                                                       â”‚   â”‚
â”‚  â”‚     Service: membership-service                                             â”‚   â”‚
â”‚  â”‚     Instance: 172.18.0.11:8084                                             â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  3. Path Rewriting                                                          â”‚   â”‚
â”‚  â”‚     Original: /api/membership/levels                                        â”‚   â”‚
â”‚  â”‚     Rewritten: /membership/levels                                           â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  4. Load Balancing                                                          â”‚   â”‚
â”‚  â”‚     Algorithm: Round Robin                                                  â”‚   â”‚
â”‚  â”‚     Target: http://172.18.0.11:8084                                        â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  5. Request Forwarding                                                      â”‚   â”‚
â”‚  â”‚     URL: http://172.18.0.11:8084/membership/levels                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                         â”‚
â”‚           â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Membership Service (8084)                               â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚  @RestController                                                            â”‚   â”‚
â”‚  â”‚  @RequestMapping("/membership")                                             â”‚   â”‚
â”‚  â”‚  public class MembershipController {                                        â”‚   â”‚
â”‚  â”‚                                                                             â”‚   â”‚
â”‚  â”‚    @GetMapping("/levels")                                                   â”‚   â”‚
â”‚  â”‚    public Result<List<MembershipLevel>> getAllLevels() {                   â”‚   â”‚
â”‚  â”‚      // ä¸šåŠ¡é€»è¾‘å¤„ç†                                                          â”‚   â”‚
â”‚  â”‚      return Result.success(levels);                                        â”‚   â”‚
â”‚  â”‚    }                                                                        â”‚   â”‚
â”‚  â”‚  }                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                         â”‚
â”‚           â–¼                                                                         â”‚
â”‚  Response                                                                           â”‚
â”‚  {                                                                                  â”‚
â”‚    "code": 200,                                                                    â”‚
â”‚    "message": "æˆåŠŸ",                                                               â”‚
â”‚    "data": [...]                                                                   â”‚
â”‚  }                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 è´Ÿè½½å‡è¡¡ç­–ç•¥

#### 3.3.1 é»˜è®¤é…ç½®
```yaml
spring:
  cloud:
    loadbalancer:
      ribbon:
        enabled: false
      cache:
        enabled: true
        ttl: 35s
```

#### 3.3.2 å¥åº·æ£€æŸ¥
```yaml
# æœåŠ¡å¥åº·æ£€æŸ¥é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
```

---

## 4. æœåŠ¡å‘ç°æ¶æ„

### 4.1 Nacosé›†æˆé…ç½®

#### 4.1.1 Gatewayé…ç½®
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: ""  # ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´
        group: DEFAULT_GROUP
        service: gateway
        
      config:
        server-addr: localhost:8848
        file-extension: yaml
        group: DEFAULT_GROUP
        namespace: ""
```

#### 4.1.2 æœåŠ¡æ³¨å†ŒçŠ¶æ€

| æœåŠ¡åç§° | æ³¨å†ŒçŠ¶æ€ | å¥åº·çŠ¶æ€ | å®ä¾‹æ•° | è´Ÿè½½å‡è¡¡ |
|----------|----------|----------|--------|----------|
| **gateway** | âœ… å·²æ³¨å†Œ | âœ… å¥åº· | 1 | - |
| **user-service** | âœ… å·²æ³¨å†Œ | âœ… å¥åº· | 1 | Round Robin |
| **file-service** | âœ… å·²æ³¨å†Œ | âœ… å¥åº· | 1 | Round Robin |
| **admin-service** | âœ… å·²æ³¨å†Œ | âœ… å¥åº· | 1 | Round Robin |
| **membership-service** | âœ… å·²æ³¨å†Œ | âœ… å¥åº· | 1 | Round Robin |

### 4.2 æœåŠ¡å‘ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Service Discovery Flow                                   â”‚
â”‚                                                                                     â”‚
â”‚  1. Service Registration                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Service   â”‚â”€â”€POSTâ”€â”€â–ºâ”‚    Nacos    â”‚â—„â”€â”€GETâ”€â”€â”€â”‚   Gateway   â”‚                  â”‚
â”‚  â”‚  Instance   â”‚         â”‚  Registry   â”‚         â”‚             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                     â”‚
â”‚  2. Health Check                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚   Service   â”‚â—„â”€â”€Pingâ”€â”€â”¤    Nacos    â”‚                                          â”‚
â”‚  â”‚  Instance   â”‚         â”‚  Registry   â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                                     â”‚
â”‚  3. Service Discovery                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Gateway   â”‚â”€â”€Queryâ”€â”€â–ºâ”‚    Nacos    â”‚â”€â”€Listâ”€â”€â–ºâ”‚  Service    â”‚                  â”‚
â”‚  â”‚             â”‚         â”‚  Registry   â”‚         â”‚  Instances  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                     â”‚
â”‚  4. Load Balancing                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Gateway   â”‚â”€â”€Selectâ”€â–ºâ”‚Load Balancerâ”‚â”€â”€Routeâ”€â”€â–ºâ”‚  Target     â”‚                  â”‚
â”‚  â”‚             â”‚         â”‚   Strategy  â”‚         â”‚  Instance   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ç½‘å…³è¿‡æ»¤å™¨æ¶æ„

### 5.1 è¿‡æ»¤å™¨é“¾ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                Filter Chain                                         â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Global    â”‚â”€â”€â”€â–ºâ”‚   Route     â”‚â”€â”€â”€â–ºâ”‚   Custom    â”‚â”€â”€â”€â–ºâ”‚   Target    â”‚          â”‚
â”‚  â”‚  Filters    â”‚    â”‚  Filters    â”‚    â”‚  Filters    â”‚    â”‚  Service    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                                     â”‚
â”‚  Pre-Filters:                                                                      â”‚
â”‚  â€¢ CorsFilter                                                                      â”‚
â”‚  â€¢ StripPrefixFilter                                                               â”‚
â”‚  â€¢ LoadBalancerClientFilter                                                        â”‚
â”‚                                                                                     â”‚
â”‚  Post-Filters:                                                                     â”‚
â”‚  â€¢ NettyWriteResponseFilter                                                        â”‚
â”‚  â€¢ NettyRoutingFilter                                                              â”‚
â”‚  â€¢ ResponseHeaderFilter                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å½“å‰è¿‡æ»¤å™¨é…ç½®

#### 5.2.1 å…¨å±€è¿‡æ»¤å™¨
```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
```

#### 5.2.2 è·¯ç”±è¿‡æ»¤å™¨
```yaml
# è·¯å¾„å‰ç¼€è¿‡æ»¤å™¨
filters:
  - StripPrefix=1  # å»æ‰ç¬¬ä¸€ä¸ªè·¯å¾„æ®µ

# ç¤ºä¾‹é…ç½®
routes:
  - id: membership-service
    uri: lb://membership-service
    predicates:
      - Path=/api/membership/**
    filters:
      - StripPrefix=1
```

### 5.3 è‡ªå®šä¹‰è¿‡æ»¤å™¨æ‰©å±•ç‚¹

#### 5.3.1 è®¤è¯è¿‡æ»¤å™¨ (æœªæ¥æ‰©å±•)
```java
@Component
public class AuthenticationFilter implements GatewayFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // JWT TokenéªŒè¯é€»è¾‘
        return chain.filter(exchange);
    }
}
```

#### 5.3.2 é™æµè¿‡æ»¤å™¨ (æœªæ¥æ‰©å±•)
```java
@Component
public class RateLimitFilter implements GatewayFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // é™æµé€»è¾‘
        return chain.filter(exchange);
    }
}
```

---

## 6. è·¨åŸŸå’Œå®‰å…¨æ¶æ„

### 6.1 CORSé…ç½®ç­–ç•¥

#### 6.1.1 å½“å‰CORSé…ç½®
```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            # allow-credentials: true  # ç”Ÿäº§ç¯å¢ƒå¯ç”¨
```

#### 6.1.2 ç”Ÿäº§ç¯å¢ƒCORSé…ç½® (æ¨è)
```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - "https://clouddrive.example.com"
              - "https://admin.clouddrive.example.com"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders:
              - Authorization
              - Content-Type
              - X-Requested-With
            allowCredentials: true
            maxAge: 3600
```

### 6.2 å®‰å…¨æ¶æ„è®¾è®¡

#### 6.2.1 è®¤è¯æˆæƒæµç¨‹ (æœªæ¥å®ç°)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Security Flow                                          â”‚
â”‚                                                                                     â”‚
â”‚  1. Authentication                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Client    â”‚â”€â”€Loginâ”€â”€â–ºâ”‚   Gateway   â”‚â”€â”€Verifyâ”€â–ºâ”‚Auth Service â”‚                  â”‚
â”‚  â”‚             â”‚         â”‚             â”‚         â”‚             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                 â”‚                         â”‚                        â”‚
â”‚                                 â”‚                         â”‚                        â”‚
â”‚                                 â–¼                         â–¼                        â”‚
â”‚  2. Authorization                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Client    â”‚â”€â”€Requestâ–ºâ”‚   Gateway   â”‚â”€â”€Checkâ”€â”€â–ºâ”‚  JWT Token  â”‚                  â”‚
â”‚  â”‚             â”‚         â”‚  Filter     â”‚         â”‚ Validation  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                 â”‚                         â”‚                        â”‚
â”‚                                 â”‚                         â”‚                        â”‚
â”‚                                 â–¼                         â–¼                        â”‚
â”‚  3. Service Access                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Gateway   â”‚â”€â”€Routeâ”€â”€â–ºâ”‚Load Balancerâ”‚â”€â”€Forwardâ–ºâ”‚Target Serviceâ”‚                  â”‚
â”‚  â”‚             â”‚         â”‚             â”‚         â”‚             â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 å®‰å…¨æœ€ä½³å®è·µ

#### 6.3.1 è¯·æ±‚å¤´å®‰å…¨
```yaml
# å®‰å…¨å“åº”å¤´é…ç½®
spring:
  cloud:
    gateway:
      default-filters:
        - AddResponseHeader=X-Content-Type-Options, nosniff
        - AddResponseHeader=X-Frame-Options, DENY
        - AddResponseHeader=X-XSS-Protection, 1; mode=block
```

#### 6.3.2 æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
```yaml
# æ•æ„Ÿè·¯å¾„ä¿æŠ¤
routes:
  - id: actuator-security
    uri: lb://user-service
    predicates:
      - Path=/actuator/**
    filters:
      - name: RequestRateLimiter
        args:
          rate-limiter: "#{@redisRateLimiter}"
          key-resolver: "#{@ipKeyResolver}"
```

---

## 7. ç›‘æ§å’Œæ—¥å¿—æ¶æ„

### 7.1 ç›‘æ§æŒ‡æ ‡é…ç½®

#### 7.1.1 Actuatorç«¯ç‚¹é…ç½®
```yaml
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
```

#### 7.1.2 å…³é”®ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡åç§° | è¯´æ˜ | é˜ˆå€¼ |
|----------|----------|------|------|
| **ååé‡** | `gateway.requests.total` | æ€»è¯·æ±‚æ•° | - |
| **å“åº”æ—¶é—´** | `gateway.requests.duration` | è¯·æ±‚å“åº”æ—¶é—´ | < 500ms |
| **é”™è¯¯ç‡** | `gateway.requests.errors` | é”™è¯¯è¯·æ±‚ç‡ | < 5% |
| **æœåŠ¡å¥åº·** | `gateway.services.health` | æœåŠ¡å¥åº·çŠ¶æ€ | = UP |
| **è¿æ¥æ•°** | `gateway.connections.active` | æ´»è·ƒè¿æ¥æ•° | < 1000 |

### 7.2 æ—¥å¿—æ¶æ„è®¾è®¡

#### 7.2.1 æ—¥å¿—çº§åˆ«é…ç½®
```yaml
logging:
  level:
    cn.sdu.clouddrive: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web: INFO
    org.springframework.cloud.loadbalancer: INFO
    com.alibaba.nacos: INFO
```

#### 7.2.2 æ—¥å¿—æ ¼å¼æ ‡å‡†
```yaml
# æ—¥å¿—æ ¼å¼é…ç½®
logging:
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{50}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{50}] - %msg%n"
```

### 7.3 æ•…éšœæ’æŸ¥æŒ‡å—

#### 7.3.1 å¸¸è§é—®é¢˜è¯Šæ–­

| é—®é¢˜ç±»å‹ | ç—‡çŠ¶ | è¯Šæ–­æ­¥éª¤ | è§£å†³æ–¹æ¡ˆ |
|----------|------|----------|----------|
| **è·¯ç”±å¤±è´¥** | 404 Not Found | æ£€æŸ¥è·¯ç”±é…ç½® | ä¿®æ­£è·¯å¾„æ˜ å°„ |
| **æœåŠ¡ä¸å¯ç”¨** | 503 Service Unavailable | æ£€æŸ¥æœåŠ¡æ³¨å†Œ | é‡å¯æœåŠ¡ |
| **è´Ÿè½½å‡è¡¡å¤±è´¥** | é—´æ­‡æ€§é”™è¯¯ | æ£€æŸ¥å¥åº·æ£€æŸ¥ | é…ç½®å¥åº·æ£€æŸ¥ |
| **CORSé”™è¯¯** | è·¨åŸŸè¯·æ±‚å¤±è´¥ | æ£€æŸ¥CORSé…ç½® | è°ƒæ•´CORSç­–ç•¥ |

#### 7.3.2 æ—¥å¿—åˆ†æå‘½ä»¤
```bash
# æŸ¥çœ‹ç½‘å…³æ—¥å¿—
docker logs gateway --tail 100 -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker logs membership-service --tail 100 -f

# æœç´¢é”™è¯¯æ—¥å¿—
docker logs gateway 2>&1 | grep -i error

# åˆ†æè·¯ç”±æ—¥å¿—
docker logs gateway 2>&1 | grep -i "route"
```

---

## 8. éƒ¨ç½²æ¶æ„

### 8.1 Dockerå®¹å™¨åŒ–é…ç½®

#### 8.1.1 Gateway Dockerfile
```dockerfile
FROM eclipse-temurin:17-jdk AS build
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline -q
COPY src ./src
RUN mvn clean package -DskipTests -q

FROM eclipse-temurin:17-jre
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 8.1.2 Docker Composeé…ç½®
```yaml
version: '3.8'

services:
  gateway:
    build:
      context: ../apps/gateway
      dockerfile: ../../docker/Dockerfile.gateway
    container_name: gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      nacos:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
    networks:
      - cloud-drive-network
```

### 8.2 ç¯å¢ƒå˜é‡ç®¡ç†

#### 8.2.1 å¼€å‘ç¯å¢ƒ
```bash
# å¼€å‘ç¯å¢ƒå˜é‡
export SPRING_PROFILES_ACTIVE=dev
export NACOS_SERVER_ADDR=localhost:8848
export GATEWAY_PORT=8080
```

#### 8.2.2 ç”Ÿäº§ç¯å¢ƒ
```bash
# ç”Ÿäº§ç¯å¢ƒå˜é‡
export SPRING_PROFILES_ACTIVE=prod
export NACOS_SERVER_ADDR=nacos-cluster:8848
export GATEWAY_PORT=8080
export JAVA_OPTS="-Xms512m -Xmx1g"
```

### 8.3 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 8.3.1 é«˜å¯ç”¨éƒ¨ç½²
```yaml
# ç”Ÿäº§ç¯å¢ƒé«˜å¯ç”¨é…ç½®
version: '3.8'

services:
  gateway-1:
    image: clouddrive/gateway:latest
    ports:
      - "8080:8080"
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

#### 8.3.2 è´Ÿè½½å‡è¡¡å™¨é…ç½®
```nginx
# Nginxè´Ÿè½½å‡è¡¡é…ç½®
upstream gateway_backend {
    server gateway-1:8080;
    server gateway-2:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name api.clouddrive.com;
    
    location / {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 9. APIæ¥å£æ¸…å•

### 9.1 å®Œæ•´æ¥å£æ˜ å°„è¡¨

#### 9.1.1 ç”¨æˆ·æœåŠ¡æ¥å£
| æ–¹æ³• | å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|----------|------|------|
| GET | `/api/users/profile` | `/users/profile` | è·å–ç”¨æˆ·ä¿¡æ¯ | â³ å¾…å¼€å‘ |
| POST | `/api/users/register` | `/users/register` | ç”¨æˆ·æ³¨å†Œ | â³ å¾…å¼€å‘ |
| POST | `/api/users/login` | `/users/login` | ç”¨æˆ·ç™»å½• | â³ å¾…å¼€å‘ |
| PUT | `/api/users/profile` | `/users/profile` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | â³ å¾…å¼€å‘ |

#### 9.1.2 æ–‡ä»¶æœåŠ¡æ¥å£
| æ–¹æ³• | å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|----------|------|------|
| GET | `/api/files/list` | `/files/list` | è·å–æ–‡ä»¶åˆ—è¡¨ | â³ å¾…å¼€å‘ |
| POST | `/api/files/upload` | `/files/upload` | ä¸Šä¼ æ–‡ä»¶ | â³ å¾…å¼€å‘ |
| GET | `/api/files/download/{id}` | `/files/download/{id}` | ä¸‹è½½æ–‡ä»¶ | â³ å¾…å¼€å‘ |
| DELETE | `/api/files/{id}` | `/files/{id}` | åˆ é™¤æ–‡ä»¶ | â³ å¾…å¼€å‘ |

#### 9.1.3 ç®¡ç†æœåŠ¡æ¥å£
| æ–¹æ³• | å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|----------|------|------|
| GET | `/api/admin/hello` | `/admin/hello` | æµ‹è¯•æ¥å£ | âœ… å¯ç”¨ |
| POST | `/api/admin/hello2` | `/admin/hello2` | POSTæµ‹è¯• | âœ… å¯ç”¨ |
| PUT | `/api/admin/hello3` | `/admin/hello3` | PUTæµ‹è¯• | âœ… å¯ç”¨ |
| POST | `/api/admin/login` | `/admin/login` | ç®¡ç†å‘˜ç™»å½• | âœ… å¯ç”¨ |

#### 9.1.4 ä¼šå‘˜æœåŠ¡æ¥å£
| æ–¹æ³• | å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|----------|------|------|
| GET | `/api/membership/levels` | `/membership/levels` | è·å–ä¼šå‘˜ç­‰çº§ | âœ… å¯ç”¨ |
| GET | `/api/membership/levels/{id}` | `/membership/levels/{id}` | è·å–ç‰¹å®šä¼šå‘˜ç­‰çº§ | âœ… å¯ç”¨ |
| GET | `/api/membership/levels/name/{name}` | `/membership/levels/name/{name}` | æŒ‰åç§°è·å–ä¼šå‘˜ç­‰çº§ | âœ… å¯ç”¨ |

#### 9.1.5 è®¢é˜…æœåŠ¡æ¥å£
| æ–¹æ³• | å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|----------|------|------|
| GET | `/api/subscription/user/{userId}` | `/subscription/user/{userId}` | è·å–ç”¨æˆ·è®¢é˜… | âœ… å¯ç”¨ |
| GET | `/api/subscription/user/{userId}/current` | `/subscription/user/{userId}/current` | è·å–å½“å‰è®¢é˜… | âœ… å¯ç”¨ |
| POST | `/api/subscription/{id}/cancel` | `/subscription/{id}/cancel` | å–æ¶ˆè®¢é˜… | âœ… å¯ç”¨ |

#### 9.1.6 æ”¯ä»˜æœåŠ¡æ¥å£
| æ–¹æ³• | å¤–éƒ¨è·¯å¾„ | å†…éƒ¨è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|----------|----------|------|------|
| POST | `/api/payment/orders` | `/payment/orders` | åˆ›å»ºæ”¯ä»˜è®¢å• | âœ… å¯ç”¨ |
| GET | `/api/payment/orders/{id}` | `/payment/orders/{id}` | è·å–æ”¯ä»˜è®¢å• | âœ… å¯ç”¨ |
| GET | `/api/payment/orders/user/{userId}` | `/payment/orders/user/{userId}` | è·å–ç”¨æˆ·è®¢å• | âœ… å¯ç”¨ |
| POST | `/api/payment/orders/{id}/pay` | `/payment/orders/{id}/pay` | å¤„ç†æ”¯ä»˜ | âœ… å¯ç”¨ |

### 9.2 è¯·æ±‚/å“åº”ç¤ºä¾‹

#### 9.2.1 è·å–ä¼šå‘˜ç­‰çº§
```bash
# è¯·æ±‚
curl -X GET http://localhost:8080/api/membership/levels

# å“åº”
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": [
    {
      "id": "level-basic",
      "name": "åŸºç¡€ç‰ˆ",
      "storageQuota": 10737418240,
      "maxFileSize": 1073741824,
      "price": 9.99,
      "durationDays": 30,
      "features": "10GBå­˜å‚¨ç©ºé—´,å•æ–‡ä»¶1GB",
      "storageQuotaFormatted": "10 GB",
      "maxFileSizeFormatted": "1 GB",
      "isRecommended": true
    }
  ],
  "timestamp": 1751986040197
}
```

#### 9.2.2 ç®¡ç†å‘˜ç™»å½•
```bash
# è¯·æ±‚
curl -X POST http://localhost:8080/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "password"
  }'

# å“åº”
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "userId": "admin-001",
    "username": "admin",
    "userLevel": "admin",
    "email": "admin@example.com"
  }
}
```

### 9.3 é”™è¯¯å¤„ç†è§„èŒƒ

#### 9.3.1 é”™è¯¯å“åº”æ ¼å¼
```json
{
  "timestamp": "2025-07-08T15:30:00.000+00:00",
  "status": 404,
  "error": "Not Found",
  "message": "Service not available",
  "path": "/api/users/profile"
}
```

#### 9.3.2 HTTPçŠ¶æ€ç è§„èŒƒ
| çŠ¶æ€ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| 200 | æˆåŠŸ | è¯·æ±‚æˆåŠŸå¤„ç† |
| 400 | è¯·æ±‚é”™è¯¯ | å‚æ•°é”™è¯¯ã€æ ¼å¼é”™è¯¯ |
| 401 | æœªæˆæƒ | éœ€è¦è®¤è¯ |
| 403 | ç¦æ­¢è®¿é—® | æƒé™ä¸è¶³ |
| 404 | æœªæ‰¾åˆ° | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | å†…éƒ¨æœåŠ¡é”™è¯¯ |
| 503 | æœåŠ¡ä¸å¯ç”¨ | æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ |

---

## 10. æœ€ä½³å®è·µå’Œæ‰©å±•

### 10.1 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 10.1.1 è¿æ¥æ± ä¼˜åŒ–
```yaml
# Nettyè¿æ¥æ± é…ç½®
spring:
  cloud:
    gateway:
      httpclient:
        pool:
          max-connections: 500
          max-idle-time: 30s
          max-life-time: 60s
        connect-timeout: 5000
        response-timeout: 10000
```

#### 10.1.2 ç¼“å­˜ä¼˜åŒ–
```yaml
# è·¯ç”±ç¼“å­˜é…ç½®
spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      redis-rate-limiter:
        include-headers: false
        redis-script-name: request_rate_limiter
```

### 10.2 æ‰©å±•ç‚¹è¯´æ˜

#### 10.2.1 è‡ªå®šä¹‰è¿‡æ»¤å™¨
```java
@Component
public class CustomGatewayFilter implements GatewayFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // è‡ªå®šä¹‰è¿‡æ»¤é€»è¾‘
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return -1; // è¿‡æ»¤å™¨é¡ºåº
    }
}
```

#### 10.2.2 è‡ªå®šä¹‰æ–­è¨€
```java
@Component
public class CustomRoutePredicateFactory 
    extends AbstractRoutePredicateFactory<CustomRoutePredicateFactory.Config> {
    
    @Override
    public Predicate<ServerWebExchange> apply(Config config) {
        return exchange -> {
            // è‡ªå®šä¹‰æ–­è¨€é€»è¾‘
            return true;
        };
    }
    
    public static class Config {
        // é…ç½®å‚æ•°
    }
}
```

### 10.3 æ•…éšœæ¢å¤ç­–ç•¥

#### 10.3.1 ç†”æ–­å™¨é…ç½®
```yaml
# Hystrixç†”æ–­å™¨é…ç½®
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 5000
      circuitBreaker:
        requestVolumeThreshold: 20
        sleepWindowInMilliseconds: 5000
        errorThresholdPercentage: 50
```

#### 10.3.2 é‡è¯•ç­–ç•¥
```yaml
# é‡è¯•é…ç½®
spring:
  cloud:
    gateway:
      routes:
        - id: retry-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: GET,POST
```

### 10.4 ç›‘æ§å’Œå‘Šè­¦

#### 10.4.1 Prometheusç›‘æ§
```yaml
# Prometheusé…ç½®
management:
  metrics:
    export:
      prometheus:
        enabled: true
        step: 10s
        descriptions: true
```

#### 10.4.2 å‘Šè­¦è§„åˆ™
```yaml
# å‘Šè­¦è§„åˆ™é…ç½®
groups:
  - name: gateway_alerts
    rules:
      - alert: GatewayHighErrorRate
        expr: rate(gateway_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Gateway high error rate detected"
          
      - alert: GatewayHighLatency
        expr: histogram_quantile(0.95, rate(gateway_request_duration_seconds_bucket[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Gateway high latency detected"
```

---

## ğŸ“‹ æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†CloudDriveé¡¹ç›®çš„Gatewayæ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬ï¼š

1. **æ€»ä½“æ¶æ„**: åŸºäºSpring Cloud Gatewayçš„å¾®æœåŠ¡ç½‘å…³
2. **ç«¯å£è®¾è®¡**: æ¸…æ™°çš„ç«¯å£åˆ†é…å’Œå†²çªè§£å†³
3. **æ¥å£è®¾è®¡**: RESTful APIè·¯ç”±å’Œè·¯å¾„é‡å†™
4. **æœåŠ¡å‘ç°**: Nacosé›†æˆçš„æœåŠ¡æ³¨å†Œä¸å‘ç°
5. **è¿‡æ»¤å™¨**: å¯æ‰©å±•çš„è¿‡æ»¤å™¨é“¾æ¶æ„
6. **å®‰å…¨æœºåˆ¶**: CORSå’Œè®¤è¯æˆæƒè®¾è®¡
7. **ç›‘æ§æ—¥å¿—**: å®Œæ•´çš„å¯è§‚æµ‹æ€§æ–¹æ¡ˆ
8. **éƒ¨ç½²ç­–ç•¥**: Dockerå®¹å™¨åŒ–å’Œç”Ÿäº§ç¯å¢ƒé…ç½®
9. **æ¥å£æ¸…å•**: å®Œæ•´çš„APIæ¥å£æ–‡æ¡£
10. **æœ€ä½³å®è·µ**: æ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±•æŒ‡å—

å½“å‰Gatewayå·²ç»æˆåŠŸå®ç°äº†åŸºæœ¬çš„è·¯ç”±è½¬å‘åŠŸèƒ½ï¼Œä¸ºCloudDriveå¾®æœåŠ¡æ¶æ„æä¾›äº†ç»Ÿä¸€çš„APIå…¥å£ã€‚æœªæ¥å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•è®¤è¯ã€é™æµã€ç›‘æ§ç­‰é«˜çº§åŠŸèƒ½ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æ›´æ–°æ—¥æœŸ: 2025-07-08*  
*ä½œè€…: CloudDriveå›¢é˜Ÿ*